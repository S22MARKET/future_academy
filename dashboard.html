<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - أكاديمية جيل المستقبل</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.6/purify.min.js"></script>

    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f0f2f5; }
        .hidden { display: none; }
        .active-tab { background-color: #2563eb; color: white; }
        .dashboard-panel { animation: fadeIn 0.5s; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 40; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); animation: fadeIn 0.3s; }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 700px; z-index: 50; max-height: 90vh; overflow-y: auto; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #2563eb; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border-bottom: 1px solid #e2e8f0; padding: 12px 10px; text-align: right; vertical-align: middle; }
        thead { background-color: #1e293b; color: #f8fafc; }
        tbody tr:hover { background-color: #f1f5f9; }
        .ql-toolbar { border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; }
        .ql-container { border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; min-height: 120px; }
        .ql-editor { font-family: 'Tajawal', sans-serif; }
        .shake { animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    </style>
</head>
<body>

<div id="login-page" class="min-h-screen flex items-center justify-center bg-gray-100 p-4">
    <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-xl space-y-6">
        <div class="text-center">
            <i class="fas fa-graduation-cap text-6xl text-blue-600 mb-4"></i>
            <h2 class="text-3xl font-extrabold text-gray-900">أكاديمية جيل المستقبل</h2>
            <p class="mt-2 text-sm text-gray-600">لوحة التحكم الإدارية. الرجاء تسجيل الدخول للمتابعة.</p>
        </div>
        <form id="login-form" class="space-y-6">
            <input id="admin-email" type="email" autocomplete="email" required class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="البريد الإلكتروني">
            <input id="admin-password" type="password" autocomplete="current-password" required class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="كلمة المرور">
            <p id="login-error" class="hidden text-sm text-red-600 text-center"><i class="fas fa-exclamation-circle mr-1"></i> بيانات الدخول غير صحيحة.</p>
            <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent text-lg font-bold rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all">
                <i class="fas fa-sign-in-alt ml-2"></i> دخول
            </button>
        </form>
         <div class="text-center mt-4">
             <a href="index.html" class="font-medium text-blue-600 hover:text-blue-500 transition-colors"><i class="fas fa-arrow-left ml-1"></i> العودة إلى الموقع الرئيسي</a>
        </div>
    </div>
</div>

<div id="dashboard-page" class="hidden">
    <div class="relative min-h-screen md:flex">
        <div class="bg-gray-800 text-gray-100 flex justify-between md:hidden">
            <a href="#" class="block p-4 text-white font-bold">جيل المستقبل</a>
            <button id="mobile-menu-btn" class="p-4 focus:outline-none focus:bg-gray-700"><i class="fas fa-bars"></i></button>
        </div>

        <aside id="sidebar" class="bg-gray-800 text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 right-0 transform translate-x-full md:relative md:translate-x-0 transition duration-300 ease-in-out z-30 shadow-lg">
            <div class="p-3 text-center border-b border-gray-700">
                <h2 class="text-2xl font-bold">جيل المستقبل</h2>
            </div>
            <nav class="flex-1 p-2 space-y-2">
                <a href="#analytics" class="dashboard-tab active-tab flex items-center px-4 py-3 rounded-md hover:bg-blue-700 transition-colors"><i class="fas fa-chart-line fa-fw mr-3"></i> الملخص العام</a>
                <a href="finance.html" class="flex items-center px-4 py-3 rounded-md hover:bg-blue-700 transition-colors"><i class="fas fa-coins fa-fw mr-3"></i> المركز المالي</a>
                <a href="#programs" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-blue-700 transition-colors"><i class="fas fa-book-open fa-fw mr-3"></i> إدارة البرامج</a>
                <a href="#halls" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-blue-700 transition-colors"><i class="fas fa-school fa-fw mr-3"></i> إدارة القاعات</a>
                <a href="#news" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-blue-700 transition-colors"><i class="fas fa-newspaper fa-fw mr-3"></i> إدارة الأخبار</a>
                <a href="#inquiries" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-blue-700 transition-colors"><i class="fas fa-envelope-open-text fa-fw mr-3"></i> الاستفسارات الواردة</a>
                <a href="#settings" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-blue-700 transition-colors"><i class="fas fa-cogs fa-fw mr-3"></i> إعدادات الأكاديمية</a>
            </nav>
            <div class="p-4 border-t border-gray-700">
                <button id="logout-btn" class="w-full bg-red-600 py-2 rounded-md hover:bg-red-700 transition-colors"><i class="fas fa-sign-out-alt mr-2"></i> تسجيل الخروج</button>
            </div>
        </aside>

        <main class="flex-1 p-4 md:p-8 overflow-y-auto">
            <div id="analytics-panel" class="dashboard-panel"></div>
            <div id="programs-panel" class="dashboard-panel hidden"></div>
            <div id="halls-panel" class="dashboard-panel hidden"></div>
            <div id="news-panel" class="dashboard-panel hidden"></div>
            <div id="inquiries-panel" class="dashboard-panel hidden"></div>
            <div id="settings-panel" class="dashboard-panel hidden"></div>
        </main>
    </div>
</div>

<div id="modal-container"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, query, where, addDoc, doc, getDoc, setDoc, updateDoc, deleteDoc, serverTimestamp, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB-VyUd5FUMb0KCUROhQRqoyOL1V7Noguk",
      authDomain: "akadimiat-jyl-almustaqbal.firebaseapp.com",
      projectId: "akadimiat-jyl-almustaqbal",
      storageBucket: "akadimiat-jyl-almustaqbal.appspot.com",
      messagingSenderId: "495523964077",
      appId: "1:495523964077:web:c73b443dd98733ab0a9224",
      measurementId: "G-8HY9WHV1Z1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const App = {}; // Global object for our functions

    let financeChart = null;
    let transactionsChart = null;
    const getEl = (id) => document.getElementById(id);

    // --- Auth & Page Initialization ---
    onAuthStateChanged(auth, user => {
        if (user) {
            getEl('login-page').classList.add('hidden');
            getEl('dashboard-page').classList.remove('hidden');
            initializeDashboard();
        } else {
            getEl('login-page').classList.remove('hidden');
            getEl('dashboard-page').add('hidden');
        }
    });

    getEl('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = getEl('admin-email').value;
        const password = getEl('admin-password').value;
        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            getEl('login-error').classList.remove('hidden');
        }
    });

    getEl('logout-btn').addEventListener('click', () => signOut(auth));

    function initializeDashboard() {
        const tabs = document.querySelectorAll('.dashboard-tab');
        const panels = document.querySelectorAll('.dashboard-panel');
        const sidebar = getEl('sidebar');
        
        getEl('mobile-menu-btn').addEventListener('click', () => sidebar.classList.toggle('translate-x-full'));

        tabs.forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                const targetPanelId = tab.getAttribute('href').substring(1) + '-panel';
                tabs.forEach(t => t.classList.remove('active-tab'));
                tab.classList.add('active-tab');
                panels.forEach(p => p.classList.toggle('hidden', p.id !== targetPanelId));
                if (window.innerWidth < 768) sidebar.classList.add('translate-x-full');
            });
        });
        
        loadAnalytics();
        loadPrograms();
        loadHalls();
        loadNews();
        loadInquiries();
        loadSettings();
    }

    // --- Panel Loaders ---
    function loadAnalytics() {
        const panel = getEl('analytics-panel');
        panel.innerHTML = `
            <h1 class="text-3xl font-bold text-gray-800 mb-6">الملخص العام</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><i class="fas fa-envelope-open-text text-4xl text-blue-500 mr-4"></i><div><p class="text-gray-500">استفسار جديد</p><p id="new-inquiries" class="text-2xl font-bold">0</p></div></div>
                <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><i class="fas fa-chalkboard-teacher text-4xl text-purple-500 mr-4"></i><div><p class="text-gray-500">إجمالي الأساتذة</p><p id="total-teachers" class="text-2xl font-bold">0</p></div></div>
                <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><i class="fas fa-wallet text-4xl text-green-500 mr-4"></i><div><p class="text-gray-500">إجمالي الدخل</p><p id="total-income" class="text-2xl font-bold">0 د.ج</p></div></div>
                <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><i class="fas fa-receipt text-4xl text-red-500 mr-4"></i><div><p class="text-gray-500">إجمالي المصاريف</p><p id="total-expenses" class="text-2xl font-bold">0 د.ج</p></div></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-xl shadow-md"><h2 class="text-xl font-bold mb-4">الدخل والمصاريف (آخر 7 أيام)</h2><canvas id="finance-chart"></canvas></div>
                <div class="bg-white p-6 rounded-xl shadow-md"><h2 class="text-xl font-bold mb-4">أنواع المعاملات المالية</h2><canvas id="transactions-chart"></canvas></div>
            </div>`;
        updateAnalytics();
    }
    
    function loadPrograms() {
        const panel = getEl('programs-panel');
        panel.innerHTML = `<div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold text-gray-800">إدارة البرامج</h1><button id="add-program-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700"><i class="fas fa-plus mr-2"></i> إضافة برنامج</button></div>
                           <div class="bg-white p-4 rounded-xl shadow-md table-wrapper"><table><thead><tr><th>البرنامج</th><th>الأستاذ</th><th>المستوى</th><th>القاعة</th><th>التوقيت</th><th>إجراءات</th></tr></thead><tbody id="programs-table"></tbody></table></div>`;
        getEl('add-program-btn').addEventListener('click', () => App.showProgramModal());
        onSnapshot(query(collection(db, "programs"), orderBy("createdAt", "desc")), (snapshot) => {
            const tableBody = getEl('programs-table');
            if(!tableBody) return;
            tableBody.innerHTML = snapshot.empty ? '<tr><td colspan="6" class="text-center p-8">لم تتم إضافة أي برامج بعد.</td></tr>' : '';
            snapshot.docs.forEach(doc => {
                const program = {id: doc.id, ...doc.data()};
                const row = tableBody.insertRow();
                row.innerHTML = `<td class="font-semibold">${program.title}</td><td>${program.teacher}</td><td>${program.level}</td><td>${program.hall}</td><td class="font-mono">${program.startTime} - ${program.endTime}</td>
                                 <td><button class="text-yellow-500 hover:text-yellow-700 mr-3" onclick='App.showProgramModal(${JSON.stringify(program)})'><i class="fas fa-edit fa-lg"></i></button>
                                     <button class="text-red-500 hover:text-red-700" onclick="App.confirmDelete('programs', '${program.id}')"><i class="fas fa-trash fa-lg"></i></button></td>`;
            });
        });
    }
    
    function loadHalls() {
        const panel = getEl('halls-panel');
        panel.innerHTML = `<div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold text-gray-800">إدارة القاعات</h1><button id="add-hall-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700"><i class="fas fa-plus mr-2"></i> إضافة قاعة</button></div>
                           <div class="bg-white p-4 rounded-xl shadow-md table-wrapper"><table><thead><tr><th>صورة</th><th>اسم القاعة</th><th>الوصف</th><th>إجراءات</th></tr></thead><tbody id="halls-table"></tbody></table></div>`;
        getEl('add-hall-btn').addEventListener('click', () => App.showHallModal());
        onSnapshot(query(collection(db, "halls"), orderBy("createdAt", "desc")), (snapshot) => {
            const tableBody = getEl('halls-table');
            if(!tableBody) return;
            tableBody.innerHTML = snapshot.empty ? '<tr><td colspan="4" class="text-center p-8">لم تتم إضافة أي قاعات بعد.</td></tr>' : '';
            snapshot.docs.forEach(doc => {
                const hall = {id: doc.id, ...doc.data()};
                const row = tableBody.insertRow();
                row.innerHTML = `<td><img src="${hall.imageUrl}" class="w-24 h-16 object-cover rounded-md"></td><td class="font-semibold">${hall.name}</td><td>${hall.description}</td>
                                 <td><button class="text-yellow-500 hover:text-yellow-700 mr-3" onclick='App.showHallModal(${JSON.stringify(hall)})'><i class="fas fa-edit fa-lg"></i></button>
                                     <button class="text-red-500 hover:text-red-700" onclick="App.confirmDelete('halls', '${hall.id}', '${hall.imageUrl}')"><i class="fas fa-trash fa-lg"></i></button></td>`;
            });
        });
    }

    function loadNews() {
        const panel = getEl('news-panel');
        panel.innerHTML = `<div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold text-gray-800">إدارة الأخبار</h1><button id="add-news-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700"><i class="fas fa-plus mr-2"></i> إضافة خبر</button></div>
                           <div id="news-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>`;
        getEl('add-news-btn').addEventListener('click', () => App.showNewsModal());
        onSnapshot(query(collection(db, "news"), orderBy("createdAt", "desc")), (snapshot) => {
            const grid = getEl('news-grid');
            if(!grid) return;
            grid.innerHTML = snapshot.empty ? '<p class="text-center text-gray-500 col-span-full mt-8">لا توجد أخبار.</p>' : '';
            snapshot.forEach(doc => {
                const article = {id: doc.id, ...doc.data()};
                const card = document.createElement('div');
                card.className = `bg-white rounded-xl shadow-md flex flex-col`;
                card.innerHTML = `
                    <img src="${article.imageUrl}" class="w-full h-48 object-cover rounded-t-xl">
                    <div class="p-4 flex-grow flex flex-col">
                        <h3 class="font-bold text-lg mb-2">${article.title}</h3>
                        <div class="text-gray-600 text-sm mb-3 flex-grow ql-editor-display"></div>
                        <div class="border-t mt-4 pt-3 flex justify-end gap-3">
                            <button class="text-yellow-500 hover:text-yellow-700" onclick='App.showNewsModal(${JSON.stringify(article)})'><i class="fas fa-edit"></i> تعديل</button>
                            <button class="text-red-500 hover:text-red-700" onclick="App.confirmDelete('news', '${article.id}', '${article.imageUrl}')"><i class="fas fa-trash"></i> حذف</button>
                        </div>
                    </div>`;
                card.querySelector('.ql-editor-display').innerHTML = DOMPurify.sanitize(article.content);
                grid.appendChild(card);
            });
        });
    }

    function loadInquiries() {
        const panel = getEl('inquiries-panel');
        panel.innerHTML = `<h1 class="text-3xl font-bold text-gray-800 mb-6">الاستفسارات الواردة</h1>
                           <div class="bg-white p-4 rounded-xl shadow-md table-wrapper"><table><thead><tr><th>التاريخ</th><th>الاسم</th><th>الهاتف</th><th>الرسالة</th><th>الحالة</th><th>إجراء</th></tr></thead><tbody id="inquiries-table"></tbody></table></div>`;
        
        onSnapshot(query(collection(db, "inquiries"), orderBy("createdAt", "desc")), (snapshot) => {
            const tableBody = getEl('inquiries-table');
            if(!tableBody) return;
            tableBody.innerHTML = snapshot.empty ? '<tr><td colspan="6" class="text-center p-8">لا توجد أي استفسارات.</td></tr>' : '';
            snapshot.docs.forEach(doc => {
                const inquiry = {id: doc.id, ...doc.data()};
                const isNew = inquiry.status === 'new';
                const row = tableBody.insertRow();
                row.className = isNew ? 'font-bold bg-blue-50' : '';
                row.innerHTML = `
                    <td>${inquiry.createdAt.toDate().toLocaleDateString('ar-EG')}</td>
                    <td>${inquiry.fullName}</td>
                    <td>${inquiry.phone}</td>
                    <td class="whitespace-normal">${inquiry.message}</td>
                    <td><span class="px-2 py-1 text-xs rounded-full ${isNew ? 'bg-blue-200 text-blue-800' : 'bg-gray-200 text-gray-800'}">${isNew ? 'جديد' : 'مقروء'}</span></td>
                    <td>${isNew ? `<button onclick="App.markInquiryAsRead('${inquiry.id}')" class="text-green-600 hover:text-green-800"><i class="fas fa-check-circle"></i> تمييز كمقروء</button>` : ''}</td>`;
            });
        });
    }

    function loadSettings() {
        const panel = getEl('settings-panel');
        panel.innerHTML = `<h1 class="text-3xl font-bold text-gray-800 mb-6">إعدادات الأكاديمية</h1>
            <div class="bg-white p-8 rounded-xl shadow-md max-w-2xl mx-auto">
                <h2 class="text-xl font-bold mb-4">معلومات التواصل</h2>
                <form id="settings-form" class="space-y-4">
                    <div class="flex items-center gap-3"><i class="fab fa-facebook-f fa-fw w-6 text-center text-gray-500"></i><input type="url" name="facebookUrl" placeholder="رابط صفحة الفيسبوك" class="w-full p-2 border rounded"></div>
                    <div class="flex items-center gap-3"><i class="fab fa-whatsapp fa-fw w-6 text-center text-gray-500"></i><input type="text" name="whatsappNumber" placeholder="رقم الواتساب (مثال: 213555...)" class="w-full p-2 border rounded"></div>
                    <div class="flex items-center gap-3"><i class="fas fa-phone-alt fa-fw w-6 text-center text-gray-500"></i><input type="text" name="phoneNumber" placeholder="رقم الهاتف" class="w-full p-2 border rounded"></div>
                    <div class="text-left mt-6">
                        <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">حفظ التغييرات</button>
                    </div>
                </form>
            </div>`;

        const form = getEl('settings-form');
        const settingsRef = doc(db, "settings", "general");

        getDoc(settingsRef).then(docSnap => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                form.facebookUrl.value = data.socialLinks?.facebook1 || '';
                form.whatsappNumber.value = data.socialLinks?.whatsapp1 || '';
                form.phoneNumber.value = data.socialLinks?.phone1 || '';
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = form.querySelector('button[type="submit"]');
            App.setLoading(submitBtn, true);
            try {
                await setDoc(settingsRef, {
                    socialLinks: {
                        facebook1: form.facebookUrl.value,
                        whatsapp1: form.whatsappNumber.value,
                        phone1: form.phoneNumber.value
                    }
                });
                alert('تم حفظ الإعدادات بنجاح!');
            } catch (error) {
                alert('حدث خطأ: ' + error.message);
            } finally {
                App.setLoading(submitBtn, false);
            }
        });
    }

    // --- Analytics Update ---
    function updateAnalytics() {
        onSnapshot(collection(db, "transactions"), (snapshot) => {
            let totalIncome = 0, totalExpenses = 0;
            const dailyData = {};
            const transactionTypes = { student_payment: 0, expense: 0, income: 0 };
            for(let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                dailyData[d.toISOString().split('T')[0]] = { income: 0, expenses: 0 };
            }

            snapshot.forEach(doc => {
                const t = doc.data();
                const amount = t.amount || 0;
                if (['income', 'student_payment'].includes(t.type)) totalIncome += amount;
                else if (t.type === 'expense') totalExpenses += amount;
                if (transactionTypes.hasOwnProperty(t.type)) transactionTypes[t.type] += amount;
                if (t.createdAt?.toDate) {
                    const dateKey = t.createdAt.toDate().toISOString().split('T')[0];
                    if (dailyData[dateKey]) {
                         if (['income', 'student_payment'].includes(t.type)) dailyData[dateKey].income += amount;
                         else if (t.type === 'expense') dailyData[dateKey].expenses += amount;
                    }
                }
            });
            
            getEl('total-income').textContent = `${totalIncome.toLocaleString()} د.ج`;
            getEl('total-expenses').textContent = `${totalExpenses.toLocaleString()} د.ج`;

            const labels = Object.keys(dailyData).map(d => new Date(d).toLocaleDateString('ar-EG', {weekday: 'short'}));
            
            const financeCtx = getEl('finance-chart')?.getContext('2d');
            if(financeCtx) {
                if(financeChart) financeChart.destroy();
                financeChart = new Chart(financeCtx, { type: 'bar', data: { labels, datasets: [ { label: 'الدخل', data: Object.values(dailyData).map(d => d.income), backgroundColor: 'rgba(59, 130, 246, 0.8)' }, { label: 'المصاريف', data: Object.values(dailyData).map(d => d.expenses), backgroundColor: 'rgba(239, 68, 68, 0.8)' } ] }, options: { responsive: true, scales: { y: { beginAtZero: true } } } });
            }
            const transactionsCtx = getEl('transactions-chart')?.getContext('2d');
            if(transactionsCtx) {
                if(transactionsChart) transactionsChart.destroy();
                transactionsChart = new Chart(transactionsCtx, { type: 'doughnut', data: { labels: ['قبض طلاب', 'مصاريف', 'دخل آخر'], datasets: [{ data: Object.values(transactionTypes), backgroundColor: ['#10b981', '#ef4444', '#f59e0b'] }] }, options: { responsive: true, plugins: { legend: { position: 'top' } } } });
            }
        });
        onSnapshot(query(collection(db, "inquiries"), where("status", "==", "new")), s => getEl('new-inquiries').textContent = s.size);
        onSnapshot(query(collection(db, "employees"), where("role", "==", "أستاذ")), s => getEl('total-teachers').textContent = s.size);
    }
    
    // --- Modals & Utilities ---
    App.setLoading = (button, isLoading) => {
        if (isLoading) {
            button.disabled = true;
            button.dataset.originalText = button.innerHTML;
            button.innerHTML = '<div class="loader !w-6 !h-6 !border-2 mx-auto"></div>';
        } else {
            button.disabled = false;
            button.innerHTML = button.dataset.originalText;
        }
    };
    
    App.showModal = (content, onConfirm) => {
        getEl('modal-container').innerHTML = `<div class="modal-backdrop"><div class="modal-content">${content}</div></div>`;
        getEl('modal-container').querySelector('.modal-backdrop').addEventListener('click', (e) => { if(e.target === e.currentTarget) App.closeModal(); });
        if(onConfirm) {
            const form = getEl('data-form');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = form.querySelector('button[type="submit"]');
                App.setLoading(submitBtn, true);
                try {
                    await onConfirm(form);
                    App.closeModal();
                } catch (error) {
                    console.error("Operation failed:", error);
                    alert("حدث خطأ: " + error.message);
                    App.setLoading(submitBtn, false);
                }
            });
        }
    };
    App.closeModal = () => { getEl('modal-container').innerHTML = ''; };
    
    App.showProgramModal = async (program = null) => {
        const hallsSnapshot = await getDocs(collection(db, "halls"));
        const hallsOptions = hallsSnapshot.docs.map(doc => {
            const hall = doc.data();
            const isSelected = program && program.hall === hall.name ? 'selected' : '';
            return `<option value="${hall.name}" ${isSelected}>${hall.name}</option>`;
        }).join('');

        const content = `<h2 class="text-2xl font-bold mb-4">${program ? 'تعديل' : 'إضافة'} برنامج</h2>
            <form id="data-form" class="space-y-4">
                <input type="text" name="title" placeholder="عنوان البرنامج" required class="w-full p-2 border rounded" value="${program?.title || ''}">
                <textarea name="description" placeholder="وصف البرنامج" required rows="3" class="w-full p-2 border rounded">${program?.description || ''}</textarea>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-2 border-t mt-4">
                    <input type="text" name="teacher" placeholder="اسم الأستاذ" required class="w-full p-2 border rounded" value="${program?.teacher || ''}">
                    <input type="text" name="level" placeholder="المستوى (ابتدائي، متوسط...)" required class="w-full p-2 border rounded" value="${program?.level || ''}">
                    <select name="hall" required class="w-full p-2 border rounded"><option value="">اختر القاعة</option>${hallsOptions}</select>
                    <div></div>
                    <div class="flex items-center gap-2"><label for="startTime" class="text-sm">من:</label><input type="time" name="startTime" required class="w-full p-2 border rounded" value="${program?.startTime || ''}"></div>
                    <div class="flex items-center gap-2"><label for="endTime" class="text-sm">إلى:</label><input type="time" name="endTime" required class="w-full p-2 border rounded" value="${program?.endTime || ''}"></div>
                </div>
                <div class="flex justify-end gap-4 pt-4"><button type="button" onclick="App.closeModal()" class="bg-gray-200 px-6 py-2 rounded-lg">إلغاء</button><button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg">حفظ</button></div>
            </form>`;
        
        App.showModal(content, async (form) => {
            const data = { title: form.title.value, description: form.description.value, teacher: form.teacher.value, level: form.level.value, hall: form.hall.value, startTime: form.startTime.value, endTime: form.endTime.value, updatedAt: serverTimestamp() };
            if (program) await updateDoc(doc(db, "programs", program.id), data);
            else { data.createdAt = serverTimestamp(); await addDoc(collection(db, "programs"), data); }
        });
    };

    App.showHallModal = (hall = null) => {
        const content = `<h2 class="text-2xl font-bold mb-4">${hall ? 'تعديل' : 'إضافة'} قاعة</h2>
            <form id="data-form" class="space-y-4">
                <input type="text" name="name" placeholder="اسم القاعة" required class="w-full p-2 border rounded" value="${hall?.name || ''}">
                <textarea name="description" placeholder="وصف القاعة" required class="w-full p-2 border rounded">${hall?.description || ''}</textarea>
                <label class="font-semibold block">صورة القاعة</label>
                <input type="file" name="image" class="w-full p-2 border rounded text-sm" accept="image/*" ${hall ? '' : 'required'}>
                <div id="image-preview" class="mt-2">${hall ? `<img src="${hall.imageUrl}" class="w-32 h-auto rounded">` : ''}</div>
                <div class="flex justify-end gap-4 pt-4"><button type="button" onclick="App.closeModal()" class="bg-gray-200 px-6 py-2 rounded-lg">إلغاء</button><button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg">حفظ</button></div>
            </form>`;
        App.showModal(content, async (form) => {
            const data = { name: form.name.value, description: form.description.value, updatedAt: serverTimestamp() };
            const imageFile = form.image.files[0];
            if (imageFile) {
                const storageRef = ref(storage, `halls/${Date.now()}_${imageFile.name}`);
                await uploadBytes(storageRef, imageFile);
                data.imageUrl = await getDownloadURL(storageRef);
                if (hall?.imageUrl) await deleteObject(ref(storage, hall.imageUrl)).catch(console.error);
            }
            if (hall) await updateDoc(doc(db, "halls", hall.id), data);
            else { data.createdAt = serverTimestamp(); await addDoc(collection(db, "halls"), data); }
        });
        getEl('data-form').image.addEventListener('change', e => { if(e.target.files[0]) getEl('image-preview').innerHTML = `<img src="${URL.createObjectURL(e.target.files[0])}" class="w-32 h-auto rounded">`; });
    };
    
    App.showNewsModal = (article = null) => {
        const content = `<h2 class="text-2xl font-bold mb-4">${article ? 'تعديل' : 'إضافة'} خبر</h2>
            <form id="data-form" class="space-y-4">
                <input type="text" name="title" placeholder="عنوان الخبر" required class="w-full p-2 border rounded" value="${article?.title || ''}">
                <label class="font-semibold">صورة الخبر</label><input type="file" name="image" class="w-full p-2 border rounded text-sm" accept="image/*" ${article ? '' : 'required'}><div id="image-preview" class="mt-2">${article ? `<img src="${article.imageUrl}" class="w-32 h-auto rounded">` : ''}</div>
                <label class="font-semibold">محتوى الخبر</label><div id="content-editor" style="min-height: 150px;"></div>
                <div class="flex justify-end gap-4 pt-4"><button type="button" onclick="App.closeModal()" class="bg-gray-200 px-6 py-2 rounded-lg">إلغاء</button><button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg">حفظ</button></div>
            </form>`;
        let quill;
        App.showModal(content, async (form) => {
            const contentHTML = DOMPurify.sanitize(quill.root.innerHTML);
            const data = { title: form.title.value, content: contentHTML, updatedAt: serverTimestamp() };
            const imageFile = form.image.files[0];
            if (imageFile) {
                const storageRef = ref(storage, `news/${Date.now()}_${imageFile.name}`);
                await uploadBytes(storageRef, imageFile);
                data.imageUrl = await getDownloadURL(storageRef);
                if (article?.imageUrl) await deleteObject(ref(storage, article.imageUrl)).catch(console.error);
            }
            if (article) await updateDoc(doc(db, "news", article.id), data);
            else { data.createdAt = serverTimestamp(); await addDoc(collection(db, "news"), data); }
        });
        quill = new Quill('#content-editor', { theme: 'snow' });
        if(article?.content) quill.root.innerHTML = article.content;
        getEl('data-form').image.addEventListener('change', e => { if(e.target.files[0]) getEl('image-preview').innerHTML = `<img src="${URL.createObjectURL(e.target.files[0])}" class="w-32 h-auto rounded">`; });
    };

    App.markInquiryAsRead = async (id) => {
        await updateDoc(doc(db, "inquiries", id), { status: 'read' });
    };

    App.confirmDelete = (collectionName, docId, imageUrl = null) => {
        const content = `<div class="text-center"><i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-4"></i><p class="text-lg font-bold">هل أنت متأكد؟</p><p class="text-gray-600 mb-4">هذا الإجراء لا يمكن التراجع عنه.</p></div>
                         <div class="flex justify-center gap-4 mt-6"><button id="cancel-btn" class="bg-gray-200 px-6 py-2 rounded-lg">إلغاء</button><button id="confirm-btn" class="bg-red-600 text-white px-6 py-2 rounded-lg">تأكيد الحذف</button></div>`;
        getEl('modal-container').innerHTML = `<div class="modal-backdrop"><div class="modal-content">${content}</div></div>`;
        getEl('cancel-btn').onclick = App.closeModal;
        getEl('confirm-btn').onclick = async () => {
            App.showLoadingModal();
            try {
                await deleteDoc(doc(db, collectionName, docId));
                if (imageUrl) await deleteObject(ref(storage, imageUrl)).catch(console.error);
                App.closeModal();
            } catch (error) {
                alert("فشل الحذف: " + error.message);
                App.closeModal();
            }
        };
    };
    App.showLoadingModal = () => getEl('modal-container').innerHTML = `<div class="modal-backdrop"><div class="loader"></div></div>`;

    // Assign App object to window to be accessible from inline HTML onclick attributes
    window.App = App;
</script>
</body>
</html>